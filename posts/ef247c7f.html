<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf8"><meta name="viewport" content="initial-scale=1,width=device-width"><title>K8S常用yaml汇总 | 失落之地</title><meta name="description" content=""><meta name="keywords" content=""><link rel="apple-touch-icon" sizes="180x180" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="32x32" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="16x16" href="/images/rock-gesture.svg"><link rel="mask-icon" href="/images/rock-gesture.svg" color=""><link rel="stylesheet" type="text/css" href="/css/layout.css"><link rel="stylesheet" type="text/css" href="/css/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="head"><div class="nav"><a href="/" class="nav-logo"><img alt="logo" height="60px" width="60px" src="/images/rock-gesture.svg"> </a><input id="navBtn" type="checkbox"><div class="nav-menu"><a class="nav-menu-item" href="/tipsy">胡言</a> <a class="nav-menu-item" href="/music">音樂</a> <a class="nav-menu-item" href="/devops">技術</a></div><label class="nav-btn" for="navBtn"></label></div></div><div class="body"><article class="post-content"><div class="post-inner"><div class="post-content__head"><div class="post-title">K8S常用yaml汇总</div><div class="post-info"><a href="/tags/K8S/" class="post-tag">#K8S</a> <a href="/tags/%E5%AE%B9%E5%99%A8/" class="post-tag">#容器</a> <a href="/tags/%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/" class="post-tag">#监控告警</a> <a href="/tags/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" class="post-tag">#日志收集</a> <span class="post-date">2023-02-23</span></div></div><div class="post-content__body"><div class="post-gallery"></div><p>   由于工作需要，K8S总有服务是需要重复部署的，例如监控、日志等，每此都从网上整理很麻烦，而且往往有错误或者因K8S版本原因需要修改。虽然使用helm或者operator方式部署更为方便，但都是经过别人封装的东西，且万变不离yaml。本文旨在记录一些常用的组件yaml，做到开箱即用——至少在我本地直接kubectl apply -f 就可以运行。诚然，有不规范或不严谨的地方在所难免，往各位海涵。</p><blockquote><p>说明：</p><p>1、涉及到的数据存储都依赖于StorageClass，需要K8S集群内提前创建。</p><p>2、使用的镜像如不加tag，即使用latest镜像，以供使用者有需要添加制定版本的tag。</p><p>3、个人习惯创建资源的顺序为 <code>RBAC</code> → <code>Configmap/Secret</code> → <code>Deployment/Statefulset/Deamonset</code> → <code>Service</code> ，实际可按需使用 <code>Ingress</code>。</p></blockquote><h1 id="通用类"><a class="markdownIt-Anchor" href="#通用类"></a> 通用类</h1><h2 id="grafana"><a class="markdownIt-Anchor" href="#grafana"></a> Grafana</h2><h3 id="01-grafana-pvcyaml"><a class="markdownIt-Anchor" href="#01-grafana-pvcyaml"></a> 01-grafana-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、storage 存储大小</span></span><br><span class="line"><span class="comment"># 2、storageclass 名称</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br></pre></td></tr></table></figure><h3 id="02-grafana-deployyaml"><a class="markdownIt-Anchor" href="#02-grafana-deployyaml"></a> 02-grafana-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/grafana</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-data-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-data-volume</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">grafana-data</span></span><br></pre></td></tr></table></figure><h3 id="03-grafana-svcyaml"><a class="markdownIt-Anchor" href="#03-grafana-svcyaml"></a> 03-grafana-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-grafana</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31001</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br></pre></td></tr></table></figure><hr><h2 id="minio"><a class="markdownIt-Anchor" href="#minio"></a> Minio</h2><blockquote><p>因Minio简单，此处以minio作为后续用到的对象存储，有其他对象存储的可以略过。</p></blockquote><h3 id="01-minio-pvcyaml"><a class="markdownIt-Anchor" href="#01-minio-pvcyaml"></a> 01-minio-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、storage 存储大小</span></span><br><span class="line"><span class="comment"># 2、storageclass 名称</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br></pre></td></tr></table></figure><h3 id="02-minio-deployyaml"><a class="markdownIt-Anchor" href="#02-minio-deployyaml"></a> 02-minio-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、console-address minio控制台端口</span></span><br><span class="line"><span class="comment"># 2、MINIO_ROOT_USER/MINIO_ROOT_PASSWORD 登录minio控制台的账号密码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">minio/minio</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">server</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/data</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--console-address&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;:9001&#x27;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_ROOT_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;admin123&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-minio</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-console</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9001</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">minio-data-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">minio-data-volume</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">minio-data</span></span><br></pre></td></tr></table></figure><h3 id="03-minio-svcyaml"><a class="markdownIt-Anchor" href="#03-minio-svcyaml"></a> 03-minio-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">minio-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-minio</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">console-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-console</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">minio</span></span><br></pre></td></tr></table></figure><h1 id="日志"><a class="markdownIt-Anchor" href="#日志"></a> 日志</h1><blockquote><p>相对于重量级日志分析的ELK(F)，这里使用更为轻量的Lok仅仅作为日志的查看工具，并对接minio。</p></blockquote><h2 id="loki"><a class="markdownIt-Anchor" href="#loki"></a> Loki</h2><h3 id="01-loki-rbacyaml"><a class="markdownIt-Anchor" href="#01-loki-rbacyaml"></a> 01-loki-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">podsecuritypolicies</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">use</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h3 id="02-loki-cmyaml"><a class="markdownIt-Anchor" href="#02-loki-cmyaml"></a> 02-loki-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、shared_store 存储类型</span></span><br><span class="line"><span class="comment"># 2、s3 对象存储的aksk及url</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">loki.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    auth_enabled: false</span></span><br><span class="line"><span class="string">    server:</span></span><br><span class="line"><span class="string">      http_listen_port: 3100</span></span><br><span class="line"><span class="string">    ingester:</span></span><br><span class="line"><span class="string">      lifecycler:       #配置ingester的生命周期，以及在哪里注册以进行发现</span></span><br><span class="line"><span class="string">        ring:</span></span><br><span class="line"><span class="string">          kvstore:</span></span><br><span class="line"><span class="string">            store: inmemory      # 用于ring的后端存储，支持consul、etcd、inmemory</span></span><br><span class="line"><span class="string">          replication_factor: 1      # 写入和读取的ingesters数量，至少为1（为了冗余和弹性，默认情况下为3）</span></span><br><span class="line"><span class="string">      chunk_idle_period: 3m      # 如果块没有达到最大的块大小，那么在刷新之前，块应该在内存中不更新多长时间</span></span><br><span class="line"><span class="string">      chunk_block_size: 262144</span></span><br><span class="line"><span class="string">      chunk_retain_period: 1m      # 块刷新后应该在内存中保留多长时间</span></span><br><span class="line"><span class="string">      max_transfer_retries: 0      # Number of times to try and transfer chunks when leaving before falling back to flushing to the store. Zero = no transfers are done.</span></span><br><span class="line"><span class="string">    schema_config:      # 配置从特定时间段开始应该使用哪些索引模式</span></span><br><span class="line"><span class="string">      configs:</span></span><br><span class="line"><span class="string">      - from: 2020-10-24      # 创建索引的日期。如果这是唯一的schema_config，则使用过去的日期，否则使用希望切换模式时的日期</span></span><br><span class="line"><span class="string">        store: boltdb-shipper      # 索引使用哪个存储，如：cassandra, bigtable, dynamodb，或boltdb</span></span><br><span class="line"><span class="string">        object_store: filesystem      # 用于块的存储，如：gcs, s3， inmemory, filesystem, cassandra，如果省略，默认值与store相同</span></span><br><span class="line"><span class="string">        schema: v11</span></span><br><span class="line"><span class="string">        index:      # 配置如何更新和存储索引</span></span><br><span class="line"><span class="string">          prefix: index_      # 所有周期表的前缀</span></span><br><span class="line"><span class="string">          period: 24h      # 表周期</span></span><br><span class="line"><span class="string">    storage_config:      # 为索引和块配置一个或多个存储</span></span><br><span class="line"><span class="string">      boltdb_shipper:</span></span><br><span class="line"><span class="string">        active_index_directory: /data/loki/boltdb-shipper-active</span></span><br><span class="line"><span class="string">        cache_location: /data/loki/boltdb-shipper-cache</span></span><br><span class="line"><span class="string">        cache_ttl: 24h         </span></span><br><span class="line"><span class="string">        # shared_store: filesystem</span></span><br><span class="line"><span class="string">        shared_store: s3</span></span><br><span class="line"><span class="string">      filesystem:</span></span><br><span class="line"><span class="string">        directory: /data/loki/chunks</span></span><br><span class="line"><span class="string">      aws:</span></span><br><span class="line"><span class="string">        s3: s3://access_key:secret_key@&lt;minio_svc_name&gt;(.&lt;minio_namspace_name&gt;.svc.cluster.local):&lt;minio_svc_port&gt;/&lt;bucket_name&gt;</span></span><br><span class="line"><span class="string">        s3forcepathstyle: true</span></span><br><span class="line"><span class="string">    limits_config:</span></span><br><span class="line"><span class="string">      enforce_metric_name: false</span></span><br><span class="line"><span class="string">      reject_old_samples: true      # 旧样品是否会被拒绝</span></span><br><span class="line"><span class="string">      reject_old_samples_max_age: 168h      # 拒绝旧样本的最大时限</span></span><br><span class="line"><span class="string">    chunk_store_config:      # 配置如何缓存块，以及在将它们保存到存储之前等待多长时间</span></span><br><span class="line"><span class="string">      max_look_back_period: 0s      #限制查询数据的时间，默认是禁用的，这个值应该小于或等于table_manager.retention_period中的值</span></span><br><span class="line"><span class="string">    table_manager:</span></span><br><span class="line"><span class="string">      retention_deletes_enabled: true      # 日志保留周期开关，用于表保留删除</span></span><br><span class="line"><span class="string">      retention_period: 48h       # 日志保留周期，保留期必须是索引/块的倍数</span></span><br><span class="line"><span class="string">    compactor:</span></span><br><span class="line"><span class="string">      working_directory: /data/loki/boltdb-shipper-compactor</span></span><br><span class="line"><span class="string">      # shared_store: filesystem</span></span><br><span class="line"><span class="string">      shared_store: s3</span></span><br><span class="line"><span class="string">      compaction_interval: 5m</span></span><br></pre></td></tr></table></figure><h3 id="03-loki-stsyaml"><a class="markdownIt-Anchor" href="#03-loki-stsyaml"></a> 03-loki-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、storage 存储大小</span></span><br><span class="line"><span class="comment"># 2、storageclass 名称</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">loki</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">fsGroup:</span> <span class="number">10001</span></span><br><span class="line">          <span class="attr">runAsGroup:</span> <span class="number">10001</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">10001</span></span><br><span class="line">      <span class="attr">initContainers:</span> []</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/loki</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-config.file=/etc/loki/loki.yaml</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-loki</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">3100</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/loki</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-wal</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/wal</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span> </span><br><span class="line">              <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-loki</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">45</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span> </span><br><span class="line">              <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-loki</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">45</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">4800</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">loki-config</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">loki-data</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">&quot;10Gi&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">loki-wal</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">&quot;5Gi&quot;</span></span><br></pre></td></tr></table></figure><h3 id="04-loki-svcyaml"><a class="markdownIt-Anchor" href="#04-loki-svcyaml"></a> 04-loki-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3100</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-loki</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">loki</span></span><br></pre></td></tr></table></figure><h2 id="promtail"><a class="markdownIt-Anchor" href="#promtail"></a> Promtail</h2><h3 id="01-promtail-rbacyaml"><a class="markdownIt-Anchor" href="#01-promtail-rbacyaml"></a> 01-promtail-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h3 id="02-protmail-cmyaml"><a class="markdownIt-Anchor" href="#02-protmail-cmyaml"></a> 02-protmail-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">promtail.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    client:      # 配置Promtail如何连接到Loki的实例</span></span><br><span class="line"><span class="string">      backoff_config:      # 配置当请求失败时如何重试请求给Loki</span></span><br><span class="line"><span class="string">        max_period: 5m </span></span><br><span class="line"><span class="string">        max_retries: 10</span></span><br><span class="line"><span class="string">        min_period: 500ms</span></span><br><span class="line"><span class="string">      batchsize: 1048576      # 发送给Loki的最大批次大小(以字节为单位)</span></span><br><span class="line"><span class="string">      batchwait: 1s      # 发送批处理前等待的最大时间（即使批次大小未达到最大值）</span></span><br><span class="line"><span class="string">      external_labels: &#123;&#125;      # 所有发送给Loki的日志添加静态标签</span></span><br><span class="line"><span class="string">      timeout: 10s      # 等待服务器响应请求的最大时间</span></span><br><span class="line"><span class="string">    positions:</span></span><br><span class="line"><span class="string">      filename: /run/promtail/positions.yaml</span></span><br><span class="line"><span class="string">    server:</span></span><br><span class="line"><span class="string">      http_listen_port: 3101</span></span><br><span class="line"><span class="string">    target_config:</span></span><br><span class="line"><span class="string">      sync_period: 10s</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: kubernetes-pods-name</span></span><br><span class="line"><span class="string">      pipeline_stages:</span></span><br><span class="line"><span class="string">        - docker: &#123;&#125;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">        - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_name</span></span><br><span class="line"><span class="string">        target_label: __service__</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_node_name</span></span><br><span class="line"><span class="string">        target_label: __host__</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">        target_label: job</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: pod</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: container</span></span><br><span class="line"><span class="string">      - replacement: /var/log/pods/*$1/*.log</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_uid</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: __path__</span></span><br><span class="line"><span class="string">    - job_name: kubernetes-pods-app</span></span><br><span class="line"><span class="string">      pipeline_stages:</span></span><br><span class="line"><span class="string">        - docker: &#123;&#125;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: .+</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_name</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_app</span></span><br><span class="line"><span class="string">        target_label: __service__</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_node_name</span></span><br><span class="line"><span class="string">        target_label: __host__</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">        target_label: job</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: pod</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: container</span></span><br><span class="line"><span class="string">      - replacement: /var/log/pods/*$1/*.log</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_uid</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: __path__</span></span><br><span class="line"><span class="string">    - job_name: kubernetes-pods-direct-controllers</span></span><br><span class="line"><span class="string">      pipeline_stages:</span></span><br><span class="line"><span class="string">        - docker: &#123;&#125;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: .+</span></span><br><span class="line"><span class="string">        separator: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_name</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_app</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;[0-9a-z-.]+-[0-9a-f]&#123;8,10&#125;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_controller_name</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_controller_name</span></span><br><span class="line"><span class="string">        target_label: __service__</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_node_name</span></span><br><span class="line"><span class="string">        target_label: __host__</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">        target_label: job</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: pod</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: container</span></span><br><span class="line"><span class="string">      - replacement: /var/log/pods/*$1/*.log</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_uid</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: __path__</span></span><br><span class="line"><span class="string">    - job_name: kubernetes-pods-indirect-controller</span></span><br><span class="line"><span class="string">      pipeline_stages:</span></span><br><span class="line"><span class="string">        - docker: &#123;&#125;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: .+</span></span><br><span class="line"><span class="string">        separator: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_name</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_app</span></span><br><span class="line"><span class="string">      - action: keep</span></span><br><span class="line"><span class="string">        regex: &#x27;[0-9a-z-.]+-[0-9a-f]&#123;8,10&#125;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_controller_name</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        regex: &#x27;([0-9a-z-.]+)-[0-9a-f]&#123;8,10&#125;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_controller_name</span></span><br><span class="line"><span class="string">        target_label: __service__</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_node_name</span></span><br><span class="line"><span class="string">        target_label: __host__</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">        target_label: job</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: pod</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: container</span></span><br><span class="line"><span class="string">      - replacement: /var/log/pods/*$1/*.log</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_uid</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: __path__</span></span><br><span class="line"><span class="string">    - job_name: kubernetes-pods-static</span></span><br><span class="line"><span class="string">      pipeline_stages:</span></span><br><span class="line"><span class="string">        - docker: &#123;&#125;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_label_component</span></span><br><span class="line"><span class="string">        target_label: __service__</span></span><br><span class="line"><span class="string">      - source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_node_name</span></span><br><span class="line"><span class="string">        target_label: __host__</span></span><br><span class="line"><span class="string">      - action: drop</span></span><br><span class="line"><span class="string">        regex: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        - __service__</span></span><br><span class="line"><span class="string">        target_label: job</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: pod</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: container</span></span><br><span class="line"><span class="string">      - replacement: /var/log/pods/*$1/*.log</span></span><br><span class="line"><span class="string">        separator: /</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_container_name</span></span><br><span class="line"><span class="string">        target_label: __path__</span></span><br></pre></td></tr></table></figure><h3 id="03-promtail-dsyaml"><a class="markdownIt-Anchor" href="#03-promtail-dsyaml"></a> 03-promtail-ds.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment">#1. client.url  loki地址</span></span><br><span class="line"><span class="comment">#2. volume docker挂载路径</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">promtail</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/promtail</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">-config.file=/etc/promtail/promtail.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-client.url=http://loki:3100/loki/api/v1/push</span></span><br><span class="line">          <span class="attr">env:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOSTNAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span> </span><br><span class="line">                <span class="attr">fieldRef:</span> </span><br><span class="line">                  <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-promtail</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">3101</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/promtail</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/run/promtail</span>              </span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data/docker/containers</span>             </span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pods</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/pods</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-promtail</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">promtail-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/run/promtail</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/docker/containers</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pods</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/pods</span></span><br></pre></td></tr></table></figure><blockquote><p>部署完成后需要在Grafana中添加Loki数据源，添加地址为&lt;loki_svc_name&gt;(.&lt;loki_namspace_name&gt;.svc.clster.local):&lt;loki_svc_port&gt;。</p></blockquote><h1 id="监控"><a class="markdownIt-Anchor" href="#监控"></a> 监控</h1><blockquote><p>除了普通Prometheus之外，对于多个Prometheus，添加Thanos方案。</p></blockquote><h2 id="alertmanager"><a class="markdownIt-Anchor" href="#alertmanager"></a> Alertmanager</h2><h3 id="01-alertmanager-cmyaml"><a class="markdownIt-Anchor" href="#01-alertmanager-cmyaml"></a> 01-alertmanager-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、邮箱smtp等账户信息</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">alertmanager.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    # 发送邮箱配置</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      resolve_timeout: 1m</span></span><br><span class="line"><span class="string">      #用于发送邮件的邮箱的SMTP服务器地址+端口</span></span><br><span class="line"><span class="string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span></span><br><span class="line"><span class="string">      # 从哪个邮箱发送报警</span></span><br><span class="line"><span class="string">      smtp_from: &#x27;&lt;mail_address&gt;&#x27;</span></span><br><span class="line"><span class="string">      # 发送邮箱的认证用户，不是邮箱名</span></span><br><span class="line"><span class="string">      smtp_auth_username: &#x27;&lt;user_name&gt;&#x27;</span></span><br><span class="line"><span class="string">      # 发送邮箱的授权码而不是登录密码</span></span><br><span class="line"><span class="string">      smtp_auth_password: &#x27;poxuwotjhdbybdfb&#x27;</span></span><br><span class="line"><span class="string">      smtp_require_tls: false</span></span><br><span class="line"><span class="string">    route:</span></span><br><span class="line"><span class="string">      group_by: [alertname]</span></span><br><span class="line"><span class="string">      group_wait: 10s</span></span><br><span class="line"><span class="string">      group_interval: 10s</span></span><br><span class="line"><span class="string">      repeat_interval: 10m</span></span><br><span class="line"><span class="string">      receiver: public</span></span><br><span class="line"><span class="string">    # 接收邮箱配置</span></span><br><span class="line"><span class="string">    receivers:</span></span><br><span class="line"><span class="string">    - name: &#x27;public&#x27;</span></span><br><span class="line"><span class="string">      # 接收邮箱地址</span></span><br><span class="line"><span class="string">      email_configs:</span></span><br><span class="line"><span class="string">      - to: &#x27;&lt;mail_address&gt;&#x27;</span></span><br><span class="line"><span class="string">        send_resolved: true</span></span><br></pre></td></tr></table></figure><h3 id="02-alertmanager-pvcyaml"><a class="markdownIt-Anchor" href="#02-alertmanager-pvcyaml"></a> 02-alertmanager-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、storage 存储大小</span></span><br><span class="line"><span class="comment"># 2、storageclass 名称</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br></pre></td></tr></table></figure><h3 id="03-alertmanager-deployyaml"><a class="markdownIt-Anchor" href="#03-alertmanager-deployyaml"></a> 03-alertmanager-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config.file=/etc/config/alertmanager.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.path=/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--cluster.advertise-address=0.0.0.0:9093</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-alert</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9093</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/#/status</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2500Mi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alert-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alert-data-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/data&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alert-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">alertmanager-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alert-data-volume</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">alertmanager-data</span></span><br></pre></td></tr></table></figure><h3 id="04-alertmanager-svcyaml"><a class="markdownIt-Anchor" href="#04-alertmanager-svcyaml"></a> 04-alertmanager-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-alert</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br></pre></td></tr></table></figure><h2 id="metrics"><a class="markdownIt-Anchor" href="#metrics"></a> Metrics</h2><h3 id="node-exporter"><a class="markdownIt-Anchor" href="#node-exporter"></a> Node-Exporter</h3><h4 id="01-node-exporter-dsyaml"><a class="markdownIt-Anchor" href="#01-node-exporter-dsyaml"></a> 01-node-exporter-ds.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--path.procfs</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/host/proc</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--path.sysfs</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/host/sys</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--path.rootfs</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/host/root</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;--collector.processes&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-node</span></span><br><span class="line">            <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span>        </span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/host/dev</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/host/proc</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rootfs</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/host/root</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rootfs</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure><h4 id="02-node-exporter-svcyaml可以省略"><a class="markdownIt-Anchor" href="#02-node-exporter-svcyaml可以省略"></a> 02-node-exporter-svc.yaml（可以省略）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-node</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-exporter</span></span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter"><a class="markdownIt-Anchor" href="#blackbox-exporter"></a> Blackbox-Exporter</h3><h4 id="01-blackbox-exporter-cmyaml"><a class="markdownIt-Anchor" href="#01-blackbox-exporter-cmyaml"></a> 01-blackbox-exporter-cm.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">blackbox-exporter-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">blackbox-exporter</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">blackbox.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    modules:</span></span><br><span class="line"><span class="string">      http_2xx:</span></span><br><span class="line"><span class="string">        prober: http</span></span><br><span class="line"><span class="string">        timeout: 10s</span></span><br><span class="line"><span class="string">        http:</span></span><br><span class="line"><span class="string">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span></span><br><span class="line"><span class="string">          valid_status_codes: []</span></span><br><span class="line"><span class="string">          method: GET</span></span><br><span class="line"><span class="string">          preferred_ip_protocol: &quot;ip4&quot;</span></span><br><span class="line"><span class="string">      http_post_2xx:</span></span><br><span class="line"><span class="string">        prober: http</span></span><br><span class="line"><span class="string">        timeout: 10s</span></span><br><span class="line"><span class="string">        http:</span></span><br><span class="line"><span class="string">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span></span><br><span class="line"><span class="string">          method: POST</span></span><br><span class="line"><span class="string">          preferred_ip_protocol: &quot;ip4&quot;</span></span><br><span class="line"><span class="string">      tcp_connect:</span></span><br><span class="line"><span class="string">        prober: tcp</span></span><br><span class="line"><span class="string">        timeout: 10s</span></span><br><span class="line"><span class="string">      icmp:</span></span><br><span class="line"><span class="string">        prober: icmp</span></span><br><span class="line"><span class="string">        timeout: 10s</span></span><br><span class="line"><span class="string">        icmp:</span></span><br><span class="line"><span class="string">          preferred_ip_protocol: &quot;ip4&quot;</span></span><br><span class="line"><span class="string">      dns: </span></span><br><span class="line"><span class="string">        prober: dns</span></span><br><span class="line"><span class="string">        dns:</span></span><br><span class="line"><span class="string">          transport_protocol: &quot;tcp&quot; </span></span><br><span class="line"><span class="string">          preferred_ip_protocol: &quot;ip4&quot; </span></span><br><span class="line"><span class="string">          query_name: &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br></pre></td></tr></table></figure><h4 id="02-blackbox-exporter-deployyaml"><a class="markdownIt-Anchor" href="#02-blackbox-exporter-deployyaml"></a> 02-blackbox-exporter-deploy.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">blackbox-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/blackbox-exporter</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--config.file=/etc/blackbox_exporter/blackbox.yml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--web.listen-address=:9115</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-blackbox</span></span><br><span class="line">            <span class="attr">containerPort:</span> <span class="number">9115</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">9115</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">50Mi</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">60Mi</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">blackbox-config-volume</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/blackbox_exporter</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">blackbox-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">blackbox-exporter-config</span></span><br></pre></td></tr></table></figure><h4 id="03-blackbox-exporter-svcyaml"><a class="markdownIt-Anchor" href="#03-blackbox-exporter-svcyaml"></a> 03-blackbox-exporter-svc.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">blackbox-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">blackbox-exporter-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9115</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-blackbox</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">blackbox-exporter</span></span><br></pre></td></tr></table></figure><h3 id="kube-state-metrics"><a class="markdownIt-Anchor" href="#kube-state-metrics"></a> Kube-State-Metrics</h3><h4 id="01-kube-state-metrics-rbacyaml"><a class="markdownIt-Anchor" href="#01-kube-state-metrics-rbacyaml"></a> 01-kube-state-metrics-rbac.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">serviceaccounts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">resourcequotas</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">limitranges</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">persistentvolumes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cronjobs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">authentication.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tokenreviews</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">authorization.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">subjectaccessreviews</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">certificates.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">certificatesigningrequests</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpointslices</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">storage.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">storageclasses</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">volumeattachments</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mutatingwebhookconfigurations</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">validatingwebhookconfigurations</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressclasses</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">clusterrolebindings</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">clusterroles</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rolebindings</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">roles</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h4 id="02-kube-state-metrics-deployyaml"><a class="markdownIt-Anchor" href="#02-kube-state-metrics-deployyaml"></a> 02-kube-state-metrics-deploy.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kube-state-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">automountServiceAccountToken:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubesphere/kube-state-metrics:v2.8.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">            <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">telemetry</span></span><br><span class="line">            <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">65534</span></span><br></pre></td></tr></table></figure><h4 id="03-kube-state-metrics-svcyaml"><a class="markdownIt-Anchor" href="#03-kube-state-metrics-svcyaml"></a> 03-kube-state-metrics-svc.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kube-state-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-metrics</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">telemetry</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">telemetry</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kube-state-metrics</span></span><br></pre></td></tr></table></figure><h2 id="prometheus"><a class="markdownIt-Anchor" href="#prometheus"></a> Prometheus</h2><h3 id="a-idrbac01-prometheus-rbacyamla"><a class="markdownIt-Anchor" href="#a-idrbac01-prometheus-rbacyamla"></a> <a id="rbac">01-prometheus-rbac.yaml</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">    <span class="attr">verbs:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h3 id="02-prometheus-cmyaml"><a class="markdownIt-Anchor" href="#02-prometheus-cmyaml"></a> 02-prometheus-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、target url地址</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval:     15s</span></span><br><span class="line"><span class="string">      evaluation_interval: 15s</span></span><br><span class="line"><span class="string">    rule_files:</span></span><br><span class="line"><span class="string">    - /etc/prometheus/rules/*.yml</span></span><br><span class="line"><span class="string">    alerting:</span></span><br><span class="line"><span class="string">      alertmanagers:</span></span><br><span class="line"><span class="string">      - static_configs:</span></span><br><span class="line"><span class="string">        - targets: [&quot;alertmanager:9093&quot;]</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &#x27;loki&#x27;</span></span><br><span class="line"><span class="string">      honor_timestamps: true</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      metrics_path: /metrics</span></span><br><span class="line"><span class="string">      scheme: http</span></span><br><span class="line"><span class="string">      follow_redirects: true</span></span><br><span class="line"><span class="string">      enable_http2: true</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets:</span></span><br><span class="line"><span class="string">        - loki.logging.svc.cluster.local:3100</span></span><br><span class="line"><span class="string">    - job_name: &#x27;node-exporter&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class="line"><span class="string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: node      </span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_address_InternalIP]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: ip</span></span><br><span class="line"><span class="string">    - job_name: &#x27;blackbox-exporter&#x27;</span></span><br><span class="line"><span class="string">      metrics_path: /probe</span></span><br><span class="line"><span class="string">      params:</span></span><br><span class="line"><span class="string">        module: [http_2xx]  # Look for a HTTP 200 response.</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">        - targets:</span></span><br><span class="line"><span class="string">          - https://prometheus.io    # Target to probe with http.</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__address__]</span></span><br><span class="line"><span class="string">          target_label: __param_target</span></span><br><span class="line"><span class="string">        - source_labels: [__param_target]</span></span><br><span class="line"><span class="string">          target_label: instance</span></span><br><span class="line"><span class="string">        - target_label: __address__</span></span><br><span class="line"><span class="string">          replacement: blackbox-exporter:9115  # The blackbox exporter&#x27;s real hostname:port.</span></span><br><span class="line"><span class="string">    - job_name: &#x27;blackbox_tcp_connect&#x27;</span></span><br><span class="line"><span class="string">      scrape_interval: 30s</span></span><br><span class="line"><span class="string">      metrics_path: /probe</span></span><br><span class="line"><span class="string">      params:</span></span><br><span class="line"><span class="string">        module: [tcp_connect]</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">        - targets:</span></span><br><span class="line"><span class="string">          - prometheus:9090</span></span><br><span class="line"><span class="string">          - alertmanager:9093</span></span><br><span class="line"><span class="string">          - grafana.public.svc.cluster.local:3000</span></span><br><span class="line"><span class="string">          - loki.logging.svc.cluster.local:3100</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__address__]</span></span><br><span class="line"><span class="string">          target_label: __param_target</span></span><br><span class="line"><span class="string">        - source_labels: [__param_target]</span></span><br><span class="line"><span class="string">          target_label: instance</span></span><br><span class="line"><span class="string">        - target_label: __address__</span></span><br><span class="line"><span class="string">          replacement: blackbox-exporter:9115 # blackbox-exporter 服务所在的机器和端口</span></span><br><span class="line"><span class="string">    - job_name: &quot;kube-state-metrics&quot; </span></span><br><span class="line"><span class="string">      static_configs: </span></span><br><span class="line"><span class="string">        - targets: [&quot;kube-state-metrics:8080&quot;]</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-nodes-cadvisor&#x27;</span></span><br><span class="line"><span class="string">      honor_timestamps: true</span></span><br><span class="line"><span class="string">      scrape_interval: 30s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      metrics_path: /metrics</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">        insecure_skip_verify: true</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - separator: ;</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: labelmap</span></span><br><span class="line"><span class="string">      - separator: ;</span></span><br><span class="line"><span class="string">        regex: (.*)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /metrics/cadvisor</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-pods&#x27;</span></span><br><span class="line"><span class="string">      honor_timestamps: true</span></span><br><span class="line"><span class="string">      scrape_interval: 30s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      metrics_path: /metrics</span></span><br><span class="line"><span class="string">      scheme: http</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: &quot;true&quot;</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::d+)?;(d+)</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        replacement:  &lt;img src=&quot;https://www.zhihu.com/equation?tex=1:&quot; alt=&quot;1:&quot; class=&quot;ee_img tr_noresize&quot; eeimg=&quot;1&quot;&gt; 2</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - separator: ;</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: labelmap</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: (.*)</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_pod_name]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: (.*)</span></span><br><span class="line"><span class="string">        target_label: kubernetes_pod_name</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-kubelet&#x27;</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - target_label: __address__</span></span><br><span class="line"><span class="string">        replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-apiservers&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-scheduler&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        insecure_skip_verify: true</span></span><br><span class="line"><span class="string">      authorization:</span></span><br><span class="line"><span class="string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: kube-system;kube-scheduler;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-controller-manager&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        insecure_skip_verify: true</span></span><br><span class="line"><span class="string">      authorization:</span></span><br><span class="line"><span class="string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: kube-system;kube-controller-manager;https</span></span><br></pre></td></tr></table></figure><h3 id="a-idrules03-prometheus-rules-cmyamla"><a class="markdownIt-Anchor" href="#a-idrules03-prometheus-rules-cmyamla"></a> <a id="rules">03-prometheus-rules-cm.yaml</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-rules-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">    - name: hostStatsAlert</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: hostCpuUsageAlert</span></span><br><span class="line"><span class="string">        expr: sum(avg without (cpu)(irate(node_cpu&#123;mode!=&#x27;idle&#x27;&#125;[5m]))) by (instance) &gt; 0.85</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string">      - alert: hostMemUsageAlert</span></span><br><span class="line"><span class="string">        expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal &gt; 0.85</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string">      - alert: OutOfInodes</span></span><br><span class="line"><span class="string">        expr: node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/&quot;&#125; / node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/&quot;&#125; * 100 &lt; 10</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Disk is almost running out of available inodes (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: OutOfDiskSpace</span></span><br><span class="line"><span class="string">        expr: node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/rootfs&quot;&#125; / node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/rootfs&quot;&#125; * 100 &lt; 10</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Out of disk space (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Disk is almost full (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: UnusualNetworkThroughputIn</span></span><br><span class="line"><span class="string">        expr: sum by (instance) (irate(node_network_receive_bytes[2m])) / 1024 / 1024 &gt; 100</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Host network interfaces are probably receiving too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: UnusualNetworkThroughputOut</span></span><br><span class="line"><span class="string">        expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) / 1024 / 1024 &gt; 100</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Host network interfaces are probably sending too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: UnusualDiskReadRate</span></span><br><span class="line"><span class="string">        expr: sum by (instance) (irate(node_disk_bytes_read[2m])) / 1024 / 1024 &gt; 50</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Disk is probably reading too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: UnusualDiskWriteRate</span></span><br><span class="line"><span class="string">        expr: sum by (instance) (irate(node_disk_bytes_written[2m])) / 1024 / 1024 &gt; 50</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Disk is probably writing too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: UnusualDiskReadLatency</span></span><br><span class="line"><span class="string">        expr: rate(node_disk_read_time_ms[1m]) / rate(node_disk_reads_completed[1m]) &gt; 100</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Disk latency is growing (read operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: UnusualDiskWriteLatency</span></span><br><span class="line"><span class="string">        expr: rate(node_disk_write_time_ms[1m]) / rate(node_disk_writes_completedl[1m]) &gt; 100</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Disk latency is growing (write operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">    - name: http_status</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: ProbeFailed</span></span><br><span class="line"><span class="string">        expr: probe_success == 0</span></span><br><span class="line"><span class="string">        for: 1m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: error</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Probe failed (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Probe failed (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: StatusCode</span></span><br><span class="line"><span class="string">        expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400</span></span><br><span class="line"><span class="string">        for: 1m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: error</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Status Code (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;HTTP status code is not 200-399 (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: SslCertificateWillExpireSoon</span></span><br><span class="line"><span class="string">        expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;SSL certificate expires in 30 days (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: SslCertificateHasExpired</span></span><br><span class="line"><span class="string">        expr: probe_ssl_earliest_cert_expiry - time()  &lt;= 0</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: error</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;SSL certificate has expired already (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: BlackboxSlowPing</span></span><br><span class="line"><span class="string">        expr: probe_icmp_duration_seconds &gt; 2</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Blackbox slow ping (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Blackbox ping took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: BlackboxSlowRequests</span></span><br><span class="line"><span class="string">        expr: probe_http_duration_seconds &gt; 2 </span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Blackbox slow requests (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">          description: &quot;Blackbox request took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: PodCpuUsagePercent</span></span><br><span class="line"><span class="string">        expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;))by(pod) / on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) &gt; 80</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Pod cpu usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string">      - alert: PodMemoryUsagePercent</span></span><br><span class="line"><span class="string">        expr: sum(label_replace(container_memory_working_set_bytes,&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;) / on(pod) group_left kube_pod_container_resource_limits_memory_bytes&#123;pod!~&quot;prometheus.*|filebeat.*&quot;&#125;)by(pod) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 5m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;Pod emory usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string">    - name: kube-state-metrics</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: KubeStateMetricsListErrors</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span></span><br><span class="line"><span class="string">          summary: kube-state-metrics is experiencing errors in list operations.</span></span><br><span class="line"><span class="string">        expr: |</span></span><br><span class="line"><span class="string">          (sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span></span><br><span class="line"><span class="string">            /</span></span><br><span class="line"><span class="string">          sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span></span><br><span class="line"><span class="string">          &gt; 0.01</span></span><br><span class="line"><span class="string">        for: 15m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">      - alert: KubeStateMetricsWatchErrors</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span></span><br><span class="line"><span class="string">          summary: kube-state-metrics is experiencing errors in watch operations.</span></span><br><span class="line"><span class="string">        expr: |</span></span><br><span class="line"><span class="string">          (sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span></span><br><span class="line"><span class="string">            /</span></span><br><span class="line"><span class="string">          sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span></span><br><span class="line"><span class="string">          &gt; 0.01</span></span><br><span class="line"><span class="string">        for: 15m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">      - alert: KubeStateMetricsShardingMismatch</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.</span></span><br><span class="line"><span class="string">          summary: kube-state-metrics sharding is misconfigured.</span></span><br><span class="line"><span class="string">        expr: |</span></span><br><span class="line"><span class="string">          stdvar (kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) != 0</span></span><br><span class="line"><span class="string">        for: 15m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">      - alert: KubeStateMetricsShardsMissing</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.</span></span><br><span class="line"><span class="string">          summary: kube-state-metrics shards are missing.</span></span><br><span class="line"><span class="string">        expr: |</span></span><br><span class="line"><span class="string">          2^max(kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) - 1</span></span><br><span class="line"><span class="string">            -</span></span><br><span class="line"><span class="string">          sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal&#123;job=&quot;kube-state-metrics&quot;&#125;) )</span></span><br><span class="line"><span class="string">          != 0</span></span><br><span class="line"><span class="string">        for: 15m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br></pre></td></tr></table></figure><h3 id="04-prometheus-pvcyaml"><a class="markdownIt-Anchor" href="#04-prometheus-pvcyaml"></a> 04-prometheus-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、storage 存储大小</span></span><br><span class="line"><span class="comment"># 2、storageclass 名称</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br></pre></td></tr></table></figure><h3 id="05-prometheus-deployyaml"><a class="markdownIt-Anchor" href="#05-prometheus-deployyaml"></a> 05-prometheus-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config.file=/etc/prometheus/config_out/prometheus.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.path=/prometheus/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.retention=24h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.enable-lifecycle</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-p8s</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2500Mi</span> </span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/config_out</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-data-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span>   </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-rules-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-data-volume</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">prometheus-data</span></span><br></pre></td></tr></table></figure><h3 id="06-prometheus-svcyaml"><a class="markdownIt-Anchor" href="#06-prometheus-svcyaml"></a> 06-prometheus-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-p8s</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31003</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure><h2 id="thanos"><a class="markdownIt-Anchor" href="#thanos"></a> Thanos</h2><blockquote><p>本文采用sidecar模式，把prometheus和sider服务部署在一起，query服务提供跟prometheus一样的查询界面，store服务储存到minio，compact服务压缩数据文件，因为prometheus已经配置rule告警规则，故thanos的rules服务不在部署，仅供参考。（如果部署rules的话，可以在query界面中既包含prometheus本身的告警规则，也可以看到rules服务的规则），详情参考 <a target="_blank" rel="noopener" href="https://github.com/thanos-io/kube-thanos/tree/main/examples/all/manifests">Thanos-io/kube-thanso</a></p></blockquote><h3 id="01-prometheus-rbacyaml"><a class="markdownIt-Anchor" href="#01-prometheus-rbacyaml"></a> 01-prometheus-rbac.yaml</h3><blockquote><p>和 <a href="#rbac">prometheus的rbac</a> 保持一致即可</p></blockquote><h3 id="02-prometheus-tp-cmyaml"><a class="markdownIt-Anchor" href="#02-prometheus-tp-cmyaml"></a> 02-prometheus-tp-cm.yaml</h3><blockquote><p>可以由稍后的 <code>05-prometheus-sidecar-sts.yaml</code> 看出，prometheus 仅提供 <code>后缀为tmpl的模版配置文件</code> 由 sidecar 解析后生成 <code>后缀为yaml的标准配置文件</code> ，所以此configmap只是文件名不同，配置项也和prometheus的一致。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 除K8S属性如namespace外的修改点</span></span><br><span class="line"><span class="comment"># 1、target url地址</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config-tmpl</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml.tmpl:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval:     15s</span></span><br><span class="line"><span class="string">      evaluation_interval: 15s</span></span><br><span class="line"><span class="string">      external_labels:</span></span><br><span class="line"><span class="string">        cluster: prometheus-ha</span></span><br><span class="line"><span class="string">        replica: $(POD_NAME)</span></span><br><span class="line"><span class="string">    rule_files:</span></span><br><span class="line"><span class="string">    - /etc/prometheus/rules/*.yml</span></span><br><span class="line"><span class="string">    alerting:</span></span><br><span class="line"><span class="string">      alertmanagers:</span></span><br><span class="line"><span class="string">      - static_configs:</span></span><br><span class="line"><span class="string">        - targets: [&quot;alertmanager:9093&quot;]</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &#x27;loki&#x27;</span></span><br><span class="line"><span class="string">      honor_timestamps: true</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      metrics_path: /metrics</span></span><br><span class="line"><span class="string">      scheme: http</span></span><br><span class="line"><span class="string">      follow_redirects: true</span></span><br><span class="line"><span class="string">      enable_http2: true</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets:</span></span><br><span class="line"><span class="string">        - loki.tecorigin-logging.svc.cluster.local:3100</span></span><br><span class="line"><span class="string">    - job_name: &#x27;node-exporter&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class="line"><span class="string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: node      </span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_address_InternalIP]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: ip</span></span><br><span class="line"><span class="string">    - job_name: &#x27;blackbox-exporter&#x27;</span></span><br><span class="line"><span class="string">      metrics_path: /probe</span></span><br><span class="line"><span class="string">      params:</span></span><br><span class="line"><span class="string">        module: [http_2xx]  # Look for a HTTP 200 response.</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">        - targets:</span></span><br><span class="line"><span class="string">          - https://prometheus.io    # Target to probe with http.</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__address__]</span></span><br><span class="line"><span class="string">          target_label: __param_target</span></span><br><span class="line"><span class="string">        - source_labels: [__param_target]</span></span><br><span class="line"><span class="string">          target_label: instance</span></span><br><span class="line"><span class="string">        - target_label: __address__</span></span><br><span class="line"><span class="string">          replacement: blackbox-exporter:9115  # The blackbox exporter&#x27;s real hostname:port.</span></span><br><span class="line"><span class="string">    - job_name: &#x27;blackbox_tcp_connect&#x27;</span></span><br><span class="line"><span class="string">      scrape_interval: 30s</span></span><br><span class="line"><span class="string">      metrics_path: /probe</span></span><br><span class="line"><span class="string">      params:</span></span><br><span class="line"><span class="string">        module: [tcp_connect]</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">        - targets:</span></span><br><span class="line"><span class="string">          - prometheus:9090</span></span><br><span class="line"><span class="string">          - alertmanager:9093</span></span><br><span class="line"><span class="string">          - grafana.tecorigin.svc.cluster.local:3000</span></span><br><span class="line"><span class="string">          - loki.tecorigin-logging.svc.cluster.local:3100</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__address__]</span></span><br><span class="line"><span class="string">          target_label: __param_target</span></span><br><span class="line"><span class="string">        - source_labels: [__param_target]</span></span><br><span class="line"><span class="string">          target_label: instance</span></span><br><span class="line"><span class="string">        - target_label: __address__</span></span><br><span class="line"><span class="string">          replacement: blackbox-exporter:9115 # blackbox-exporter 服务所在的机器和端口</span></span><br><span class="line"><span class="string">    - job_name: &quot;kube-state-metrics&quot; </span></span><br><span class="line"><span class="string">      static_configs: </span></span><br><span class="line"><span class="string">        - targets: [&quot;kube-state-metrics:8080&quot;]</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-nodes-cadvisor&#x27;</span></span><br><span class="line"><span class="string">      honor_timestamps: true</span></span><br><span class="line"><span class="string">      scrape_interval: 30s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      metrics_path: /metrics</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">        insecure_skip_verify: true</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - separator: ;</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: labelmap</span></span><br><span class="line"><span class="string">      - separator: ;</span></span><br><span class="line"><span class="string">        regex: (.*)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /metrics/cadvisor</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-pods&#x27;</span></span><br><span class="line"><span class="string">      honor_timestamps: true</span></span><br><span class="line"><span class="string">      scrape_interval: 30s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      metrics_path: /metrics</span></span><br><span class="line"><span class="string">      scheme: http</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: &quot;true&quot;</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::d+)?;(d+)</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        replacement:  &lt;img src=&quot;https://www.zhihu.com/equation?tex=1:&quot; alt=&quot;1:&quot; class=&quot;ee_img tr_noresize&quot; eeimg=&quot;1&quot;&gt; 2</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - separator: ;</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: labelmap</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: (.*)</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_pod_name]</span></span><br><span class="line"><span class="string">        separator: ;</span></span><br><span class="line"><span class="string">        regex: (.*)</span></span><br><span class="line"><span class="string">        target_label: kubernetes_pod_name</span></span><br><span class="line"><span class="string">        replacement: $1</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-kubelet&#x27;</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - target_label: __address__</span></span><br><span class="line"><span class="string">        replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-apiservers&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-scheduler&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        insecure_skip_verify: true</span></span><br><span class="line"><span class="string">      authorization:</span></span><br><span class="line"><span class="string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: kube-system;kube-scheduler;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kube-controller-manager&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        insecure_skip_verify: true</span></span><br><span class="line"><span class="string">      authorization:</span></span><br><span class="line"><span class="string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: kube-system;kube-controller-manager;https</span></span><br></pre></td></tr></table></figure><h3 id="03-prometheus-rules-cmyaml"><a class="markdownIt-Anchor" href="#03-prometheus-rules-cmyaml"></a> 03-prometheus-rules-cm.yaml</h3><blockquote><p>如果使用prometheus自己告警规则而不是thanos-rules的话，和 <a href="#rules">prometheus的保rules</a> 保持一致即可。</p></blockquote><h3 id="04-thanos-storage-secretyaml"><a class="markdownIt-Anchor" href="#04-thanos-storage-secretyaml"></a> 04-thanos-storage-secret.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">objectstorage.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    type: S3</span></span><br><span class="line"><span class="string">    config:</span></span><br><span class="line"><span class="string">      endpoint: &quot;&lt;minio_svc_name&gt;(.&lt;minio_namspace_name&gt;.svc.cluster.local):&lt;minio_svc_port&gt;&quot;</span></span><br><span class="line"><span class="string">      bucket: &quot;&lt;bucket_name&gt;&quot;</span></span><br><span class="line"><span class="string">      access_key: &quot;&quot;</span></span><br><span class="line"><span class="string">      secret_key: &quot;&quot;</span></span><br><span class="line"><span class="string">      insecure: true  </span></span><br></pre></td></tr></table></figure><h3 id="05-prometheus-sidecar-stsyaml"><a class="markdownIt-Anchor" href="#05-prometheus-sidecar-stsyaml"></a> 05-prometheus-sidecar-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-sidecar</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus-sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">prometheus-sidebar-headless</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus-sidecar</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus-sidecar</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config.file=/etc/prometheus/config_out/prometheus.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.path=/prometheus/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.retention=24h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.enable-lifecycle</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.no-lockfile</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.min-block-duration=2h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--storage.tsdb.max-block-duration=2h</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-p8s</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-p8s</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">120</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-p8s</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/config_out</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-data-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-sidecar</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/thanos/thanos:v0.30.2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tsdb.path=/prometheus/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--prometheus.url=http://127.0.0.1:9090</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--grpc-address=0.0.0.0:10901</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--http-address=0.0.0.0:10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.rule-dir=/etc/prometheus/rules/</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-tmpl-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/config</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/config_out</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/thanos/objectstorage.yaml</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">objectstorage.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-data-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus/data</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-tmpl-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config-tmpl</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-rules-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus-data-volume</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">20Gi</span></span><br></pre></td></tr></table></figure><h3 id="06-prometheus-sidecar-svcyaml"><a class="markdownIt-Anchor" href="#06-prometheus-sidecar-svcyaml"></a> 06-prometheus-sidecar-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-sidecar-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus-sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10901</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">grpc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus-sidecar</span></span><br></pre></td></tr></table></figure><h3 id="07-thanos-store-stsyaml"><a class="markdownIt-Anchor" href="#07-thanos-store-stsyaml"></a> 07-thanos-store-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-store</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-store</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-store</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">thanos-store-headless</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-store</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-store</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/thanos/thanos:v0.30.2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">store</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--data-dir=/var/thanos/store</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--grpc-address=0.0.0.0:10901</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--http-address=0.0.0.0:10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.42</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">420Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.123</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">123Mi</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">FallbackToLogsOnError</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/thanos/store</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">thanos-store-data</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/thanos/objectstorage.yaml</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">objectstorage.yaml</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">120</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">thanos-store-data</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">thanos-store</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure><h3 id="08-thanos-store-svcyaml"><a class="markdownIt-Anchor" href="#08-thanos-store-svcyaml"></a> 08-thanos-store-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-store-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-store</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10901</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">grpc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">store</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-store</span></span><br></pre></td></tr></table></figure><h3 id="09-thanos-compact-stsyaml"><a class="markdownIt-Anchor" href="#09-thanos-compact-stsyaml"></a> 09-thanos-compact-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-compact</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-compact</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-compact</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">thanos-compact-headless</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-compact</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-compact</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/thanos/thanos:v0.30.2</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">compact</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--wait</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=info</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.format=logfmt</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--data-dir=/var/thanos/compact</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--debug.accept-malformed-index</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--retention.resolution-raw=90d</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--retention.resolution-5m=180d</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--retention.resolution-1h=360d</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">4</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.42</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">420Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.123</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">123Mi</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">FallbackToLogsOnError</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-compact-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/thanos/compact</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/thanos/objectstorage.yaml</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">objectstorage.yaml</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">120</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">thanos-compact-data</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">thanos-compact</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">100Gi</span></span><br></pre></td></tr></table></figure><h3 id="10-thanos-compact-svcyaml"><a class="markdownIt-Anchor" href="#10-thanos-compact-svcyaml"></a> 10-thanos-compact-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-compact-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-compact</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-compact</span></span><br></pre></td></tr></table></figure><h3 id="11-thanos-query-deployyaml"><a class="markdownIt-Anchor" href="#11-thanos-query-deployyaml"></a> 11-thanos-query-deploy.yaml</h3><blockquote><p>由于query需要连接sidecar还有store（部署rules的话也要），在这里我最后部署query服务，虽然先部署query它也会自动去重连store或者rules</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-query</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-query</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-query</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-query</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-query</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/thanos/thanos:v0.30.2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">query</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--grpc-address=0.0.0.0:10901</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--http-address=0.0.0.0:9090</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.format=logfmt</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query.replica-label=prometheus_replica</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query.replica-label=rule_replica</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--store=dnssrv+_grpc._tcp.prometheus-sidecar-headless</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--store=dnssrv+_grpc._tcp.thanos-store-headless</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query.timeout=5m</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query.lookback-delta=15m</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query.auto-downsampling</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-query</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">4</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-query</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http-query</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h3 id="12-thanos-query-svcyaml"><a class="markdownIt-Anchor" href="#12-thanos-query-svcyaml"></a> 12-thanos-query-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-query</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-query</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">query-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-query</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31990</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10901</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31991</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-query</span></span><br></pre></td></tr></table></figure><blockquote><p>以下rules服务为可选项</p></blockquote><h3 id="13-thanos-rules-cmyaml"><a class="markdownIt-Anchor" href="#13-thanos-rules-cmyaml"></a> 13-thanos-rules-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-rules-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">thanos-rules</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">record.rules.yaml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">    - name: k8s.rules</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - expr: |</span></span><br><span class="line"><span class="string">          sum(rate(container_cpu_usage_seconds_total&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;[5m])) by (namespace)</span></span><br><span class="line"><span class="string">        record: namespace:container_cpu_usage_seconds_total:sum_rate</span></span><br><span class="line"><span class="string">      - expr: |</span></span><br><span class="line"><span class="string">          sum(container_memory_usage_bytes&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;) by (namespace)</span></span><br><span class="line"><span class="string">        record: namespace:container_memory_usage_bytes:sum</span></span><br><span class="line"><span class="string">      - expr: |</span></span><br><span class="line"><span class="string">          sum by (namespace, pod, container) (</span></span><br><span class="line"><span class="string">            rate(container_cpu_usage_seconds_total&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;[5m])</span></span><br><span class="line"><span class="string">          )</span></span><br><span class="line"><span class="string">        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate</span></span><br></pre></td></tr></table></figure><h3 id="14-thanos-rules-stsyaml"><a class="markdownIt-Anchor" href="#14-thanos-rules-stsyaml"></a> 14-thanos-rules-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-rule</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-rule</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-rule</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">thanos-rule-headless</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-rule</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-rule</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/thanos/thanos:v0.30.2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">rule</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=info</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.format=logfmt</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--grpc-address=0.0.0.0:10901</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--http-address=0.0.0.0:10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--rule-file=/etc/thanos/rules/*rules.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--data-dir=/var/thanos/rule</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--label=rule_replica=&quot;$(NAME)&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--alert.label-drop=&quot;rule_replica&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tsdb.retention=48h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tsdb.block-duration=2h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query=dnssrv+_http._tcp.thanos-query</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">24</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">18</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.42</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">420Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">0.123</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">123Mi</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">FallbackToLogsOnError</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-rules-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/thanos/rule</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/thanos/objectstorage.yaml</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">objectstorage.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-rules-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/thanos/rules</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-rules-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">thanos-rules-config</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">thanos-rules-data</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">thanos-rule</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&lt;storageclass_name&gt;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">100Gi</span></span><br></pre></td></tr></table></figure><h3 id="15-thanos-rules-svcyaml"><a class="markdownIt-Anchor" href="#15-thanos-rules-svcyaml"></a> 15-thanos-rules-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-rule-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-rule</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10901</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">grpc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-rule</span></span><br></pre></td></tr></table></figure></div></div></article><div class="post__foot"><div class="like-author"><input type="checkbox" id="likeCode"><div class="author-face"><img height="100px" width="100px" id="front-face" alt="author face" src="/images/avatar.jpg"> <img height="100px" width="100px" id="back-face" alt="like code" src="/images/wechatpay.png"></div><div class="like-text">俾Mucy食[凍乾]~(￣▽￣)~*</div><label for="likeCode" class="like-btn"><svg viewBox="0 0 1024 1024" width="20px" style="margin-right:10px" height="20px"><path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242"/></svg> 心水</label></div><div class="post-nav"><div class="post-nav-item-left"></div><div class="vhr"></div><a class="post-nav-item-right" href="/posts/4fc885b8.html"><div class="text-align"><span class="text-small">下一篇</span> <svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" transform="scale(-1,-1)" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg></div>K8S部署方式简介</a></div></div></div><div class="foot"><div class="foot-inner"><div class="foot__head"><div class="foot-line"><div class="matts">用</div><div class="matts">捨</div><div class="matts">由</div><div class="matts">時</div></div><div class="foot-line"><div class="matts">行</div><div class="matts">藏</div><div class="matts">在</div><div class="matts">我</div></div></div><div class="foot__body"><div class="foot-item"><div class="foot-item__head">账号</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-github.svg"> <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/koanight">github</a></div><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-weibo.svg"> <a class="foot-link" target="_blank" rel="noopener" href="https://weibo.com/u/3626601454">sina</a></div></div></div><div class="foot-item"><div class="foot-item__head">联系</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"> <a class="foot-link" href="mailto:felix7cheung@163.com">felix7cheung@163.com</a></div></div></div></div><div class="copyright"><a href="http://example.com">失落之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp; <svg width="20" height="20" viewBox="0 0 725 725"><path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/><path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/><path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/></svg> <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动</div></div></div></body></html>