<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Felix Cheung"><meta name="keywords" content=""><meta name="description" content="Refencehttps:&#x2F;&#x2F;www.cnblogs.com&#x2F;lizexiong&#x2F;p&#x2F;14882419.html#blogTitle32 Enviroment   Role IP Component Hostname    master(Kubernetes,Etcd) 10.10.10.101 cfssletcddockerkube-apiserverkube-controller-manage"><meta property="og:type" content="article"><meta property="og:title" content="通过二进制方式部署Kubernetes集群"><meta property="og:url" content="http://example.com/study/kubernetes/Bianry-Deploy-Kubernetes/index.html"><meta property="og:site_name" content="Mucy&#39; Live"><meta property="og:description" content="Refencehttps:&#x2F;&#x2F;www.cnblogs.com&#x2F;lizexiong&#x2F;p&#x2F;14882419.html#blogTitle32 Enviroment   Role IP Component Hostname    master(Kubernetes,Etcd) 10.10.10.101 cfssletcddockerkube-apiserverkube-controller-manage"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/k8s.jpg"><meta property="article:published_time" content="2022-12-22T02:45:09.000Z"><meta property="article:modified_time" content="2023-01-07T09:37:02.723Z"><meta property="article:author" content="Felix Cheung"><meta property="article:tag" content="devops"><meta property="article:tag" content="kubernetes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/k8s.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>通过二进制方式部署Kubernetes集群 - Mucy&#39; Live</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:60,cursorChar:"_",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Mucy</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/k8s.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.5)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="通过二进制方式部署Kubernetes集群"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-12-22 10:45" pubdate>2022年12月22日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 24k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 198 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">通过二进制方式部署Kubernetes集群</h1><div class="markdown-body"><h1 id="Refence"><a href="#Refence" class="headerlink" title="Refence"></a>Refence</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lizexiong/p/14882419.html#blogTitle32">https://www.cnblogs.com/lizexiong/p/14882419.html#blogTitle32</a></p><h1 id="Enviroment"><a href="#Enviroment" class="headerlink" title="Enviroment"></a>Enviroment</h1><table><thead><tr><th align="center">Role</th><th align="center">IP</th><th align="center">Component</th><th align="center">Hostname</th></tr></thead><tbody><tr><td align="center">master(Kubernetes,Etcd)</td><td align="center">10.10.10.101</td><td align="center">cfssl<br>etcd<br>docker<br>kube-apiserver<br>kube-controller-manager<br>kube-scheduler<br>kubectl</td><td align="center">master</td></tr><tr><td align="center">node1(Kubernetes,Etcd)</td><td align="center">10.10.10.102</td><td align="center">etcd<br>docker<br>kubelet<br>kube-proxy</td><td align="center">minion</td></tr><tr><td align="center">node2(Kubernetes,Etcd)</td><td align="center">10.10.10.103</td><td align="center">etcd<br>docker<br>kubelet<br>kube-proxy</td><td align="center">slave</td></tr></tbody></table><h1 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h1><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭防火墙</span>
systemctl disable firewalld --now
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭selinux</span>
setenforce 0
<span class="hljs-meta prompt_">#</span><span class="language-bash">禁用,重启生效</span>
sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭swap</span>
swapoff -a
<span class="hljs-meta prompt_">#</span><span class="language-bash">永久关闭</span>
sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用软件包</span>
yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate zip unzip -y
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">设置主机名</span>
hostnamectl set-hostname &lt;hostname&gt; 
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">主机名写入hosts</span>
cat &gt;&gt; /etc/hosts &lt;&lt; EOF
10.10.10.101 master
10.10.10.102 minion
10.10.10.103 slave
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span>
ssh-keygen -t rsa
for host in master minion slave; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">内核开启网络支持</span>
cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
net.ipv4.ip_nonlocal_bind = 1
EOF
modprobe br_netfilter
sysctl -p /etc/sysctl.d/kubernetes.conf</code></pre></div><h1 id="Cfssl"><a href="#Cfssl" class="headerlink" title="Cfssl"></a>Cfssl</h1><div class="code-wrapper"><pre><code class="hljs shell">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x cfssl*

mv cfssl_linux-amd64 /usr/bin/cfssl
mv cfssljson_linux-amd64 /usr/bin/cfssljson
mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</code></pre></div><h1 id="Etcd"><a href="#Etcd" class="headerlink" title="Etcd"></a>Etcd</h1><h2 id="自签CA"><a href="#自签CA" class="headerlink" title="自签CA"></a>自签CA</h2><div class="code-wrapper"><pre><code class="hljs shell">mkdir cfssl/etcd -p &amp;&amp; cd cfssl/etcd 

cat &gt; ca-config.json &lt;&lt; EOF
&#123;
  &quot;signing&quot;: &#123;
    &quot;default&quot;: &#123;
      &quot;expiry&quot;: &quot;87600h&quot;
    &#125;,
    &quot;profiles&quot;: &#123;
      &quot;www&quot;: &#123;
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      &#125;
    &#125;
  &#125;
&#125;
EOF

cat &gt; ca-csr.json &lt;&lt; EOF
&#123;
    &quot;CN&quot;: &quot;etcd CA&quot;,
    &quot;key&quot;: &#123;
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    &#125;,
    &quot;names&quot;: [
        &#123;
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;ShangHai&quot;,
            &quot;ST&quot;: &quot;ShangHai&quot;
        &#125;
    ]
&#125;
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">生成ca.pem和ca-key.pem文件</span>
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</code></pre></div><h2 id="使用自签CA签发HTTPS证书"><a href="#使用自签CA签发HTTPS证书" class="headerlink" title="使用自签CA签发HTTPS证书"></a>使用自签CA签发HTTPS证书</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">hosts内为节点IP</span>
cat &gt; server-csr.json &lt;&lt; EOF
&#123;
    &quot;CN&quot;: &quot;etcd&quot;,
    &quot;hosts&quot;: [
    &quot;10.10.10.101&quot;,
    &quot;10.10.10.102&quot;,
    &quot;10.10.10.103&quot;
    ],
    &quot;key&quot;: &#123;
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    &#125;,
    &quot;names&quot;: [
        &#123;
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;ShangHai&quot;,
            &quot;ST&quot;: &quot;ShangHai&quot;
        &#125;
    ]
&#125;
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">生成server.pem和server-key.pem文件</span>
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</code></pre></div><h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://github.com/etcd-io/etcd/releases寻找下载</span>
mkdir /etc/etcd/&#123;bin,ssl&#125; -p
tar -mxvf etcd-v3.5.0-linux-amd64.tar
mv etcd-v3.5.0-linux-amd64.tar/etcd* /etc/etcd/bin/</code></pre></div><h2 id="Yum安装"><a href="#Yum安装" class="headerlink" title="Yum安装"></a>Yum安装</h2><div class="code-wrapper"><pre><code class="hljs shell">yum install etcd -y
mkdir /etc/etcd/ssl -p</code></pre></div><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意检查各个节点的etcd.conf中主机名和IP是否和当前节点一致(没有则新建)</span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">[Member]</span>
ETCD_NAME=&quot;etcd-master&quot;
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;https://10.10.10.101:2380&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;https://10.10.10.101:2379&quot;
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">[Clustering]</span>
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://10.10.10.101:2380&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;https://10.10.10.101:2379&quot;
ETCD_INITIAL_CLUSTER=&quot;etcd-master=https://10.10.10.101:2380,etcd-minion=https://10.10.10.102:2380,etcd-slave=https://10.10.10.103:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</code></pre></div><h2 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h2><div class="code-wrapper"><pre><code class="hljs shell">for host in master minion slave; do scp cfssl/etcd/*.pem $host:/etc/etcd/ssl/;done</code></pre></div><h2 id="修改系统服务文件"><a href="#修改系统服务文件" class="headerlink" title="修改系统服务文件"></a>修改系统服务文件</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">/lib/systemd/system/etcd.service(没有则新建)</span>
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=/etc/etcd/etcd.conf
ExecStart=/etc/etcd/etcd \
--cert-file=/etc/etcd/ssl/server.pem \
--key-file=/etc/etcd/ssl/server-key.pem \
--peer-cert-file=/etc/etcd/ssl/server.pem \
--peer-key-file=/etc/etcd/ssl/server-key.pem \
--trusted-ca-file=/etc/etcd/ssl/ca.pem \
--peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \
--logger=zap
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target</code></pre></div><h2 id="自启启动"><a href="#自启启动" class="headerlink" title="自启启动"></a>自启启动</h2><div class="code-wrapper"><pre><code class="hljs shell">for host in master minion slave;do ssh $host &#x27;systemctl daemon-reload;systemctl enable etcd --now&#x27;;done</code></pre></div><h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><div class="code-wrapper"><pre><code class="hljs shell">ETCDCTL_API=3 /etc/etcd/etcdctl --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/server.pem --key=/etc/etcd/ssl/server-key.pem --endpoints=&quot;https://10.10.10.101:2379,https://10.10.10.102:2379,https://10.10.10.103:2379&quot; endpoint health --write-out=table

+-----------------------------+--------+-------------+-------+
|          ENDPOINT           | HEALTH |    TOOK     | ERROR |
+-----------------------------+--------+-------------+-------+
| https://10.10.10.101:2379   |  true  | 50.191672ms |       |
| https://10.10.10.102:2379   |  true  | 52.394036ms |       |
| https://10.10.10.103:2379   |  true  | 46.009422ms |       |
+-----------------------------+--------+-------------+-------+</code></pre></div><h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><h2 id="手动安装-1"><a href="#手动安装-1" class="headerlink" title="手动安装"></a>手动安装</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://download.docker.com/linux/static/stable/x86_64/载</span>
tar -mxvf docker-20.10.7.tgz
mv docker/* /usr/bin
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">创建系统服务文件</span>
cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h2 id="Yum安装-1"><a href="#Yum安装-1" class="headerlink" title="Yum安装"></a>Yum安装</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">官方脚本安装</span>
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">手动yum安装</span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">卸载原有docker</span>
yum remove docker*
<span class="hljs-meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span>
yum install -y yum-utils device-mapper-persistent-data lvm2
<span class="hljs-meta prompt_">#</span><span class="language-bash">设置阿里源地址</span>
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="hljs-meta prompt_">#</span><span class="language-bash">安装</span>
yum install docker-ce docker-ce-cli containerd.io -y</code></pre></div><h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span>
mkdir /etc/docker -p
cat &gt; /etc/docker/daemon.json &lt;&lt; EOF
&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],
  &quot;exec-etcs&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;
EOF</code></pre></div><h2 id="自启启动-1"><a href="#自启启动-1" class="headerlink" title="自启启动"></a>自启启动</h2><div class="code-wrapper"><pre><code class="hljs shell">for host in master minion slave;do ssh $host &#x27;systemctl daemon-reload;systemctl enable docker --now&#x27;;done</code></pre></div><h1 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h1><h2 id="二进制文件"><a href="#二进制文件" class="headerlink" title="二进制文件"></a>二进制文件</h2><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md寻找下载</span>
mkdir -p /etc/kubernetes/&#123;bin,conf,ssl,logs&#125;
tar -mxvf kubernetes-server-linux-amd64.tar.gz
cd kubernetes/server/bin/
cp kube-apiserver kube-scheduler kube-controller-manager /etc/kubernetes/bin/
cp kubectl /usr/bin/</code></pre></div><h2 id="自签CA-1"><a href="#自签CA-1" class="headerlink" title="自签CA"></a>自签CA</h2><div class="code-wrapper"><pre><code class="hljs shell">mkdir cfssl/kubernetes -p &amp;&amp; cd cfssl/kubernetes

cat &gt; ca-config.json &lt;&lt; EOF
&#123;
  &quot;signing&quot;: &#123;
    &quot;default&quot;: &#123;
      &quot;expiry&quot;: &quot;87600h&quot;
    &#125;,
    &quot;profiles&quot;: &#123;
      &quot;kubernetes&quot;: &#123;
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      &#125;
    &#125;
  &#125;
&#125;
EOF

cat &gt; ca-csr.json &lt;&lt; EOF
&#123;
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;key&quot;: &#123;
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    &#125;,
    &quot;names&quot;: [
        &#123;
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;ShangHai&quot;,
            &quot;ST&quot;: &quot;ShangHai&quot;,
            &quot;O&quot;: &quot;Kubernetes&quot;,
            &quot;OU&quot;: &quot;System&quot;
        &#125;
    ]
&#125;
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">生成ca.pem和ca-key.pem文件</span>
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</code></pre></div><h2 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h2><h3 id="使用自签CA签-HTTPS证书"><a href="#使用自签CA签-HTTPS证书" class="headerlink" title="使用自签CA签 HTTPS证书"></a>使用自签CA签 HTTPS证书</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">hosts内为节点IP,为了方便后期扩容可以多写几个预留的IP</span>
cat &gt; server-csr.json &lt;&lt; EOF
&#123;
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;hosts&quot;: [
      &quot;10.0.0.1&quot;,
      &quot;127.0.0.1&quot;,
      &quot;10.10.10.101&quot;,
      &quot;10.10.10.102&quot;,
      &quot;10.10.10.103&quot;,
      &quot;kubernetes&quot;,
      &quot;kubernetes.default&quot;,
      &quot;kubernetes.default.svc&quot;,
      &quot;kubernetes.default.svc.cluster&quot;,
      &quot;kubernetes.default.svc.cluster.local&quot;
    ],
    &quot;key&quot;: &#123;
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    &#125;,
    &quot;names&quot;: [
        &#123;
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;ShangHai&quot;,
            &quot;ST&quot;: &quot;ShangHai&quot;,
            &quot;O&quot;: &quot;Kubernetes&quot;,
            &quot;OU&quot;: &quot;System&quot;
        &#125;
    ]
&#125;
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">生成server.pem和server-key.pem文件</span>
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span>
cp cfssl/kubernetes/*.pem /etc/kubernetes/ssl
<span class="hljs-meta prompt_">#</span><span class="language-bash">如果etcd和master不在一台机器部署，这里etcd的证书也要拷贝</span>
cp cfssl/etcd/*.pem /etc/etcd/ssl</code></pre></div><h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建token</span>
cat &gt; /opt/kubernetes/conf/token.csv &lt;&lt; EOF
c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">token也可自行生成替换</span>
head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;

cat &gt; /opt/kubernetes/conf/kube-apiserver.conf &lt;&lt; EOF
KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--etcd-servers=https://10.10.10.101:2379,https://10.10.10.102:2379,https://10.10.10.103:2379 \\
--bind-address=10.10.10.101 \\
--secure-port=6443 \\
--advertise-address=10.10.10.101 \\
--allow-privileged=true \\
--service-cluster-ip-range=10.0.0.0/24 \\
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
--authorization-mode=RBAC,Node \\
--enable-bootstrap-token-auth=true \\
--token-auth-file=/opt/kubernetes/conf/token.csv \\
--service-node-port-range=1-65535 \\
--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\
--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\
--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\
--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\
--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--service-account-issuer=api \\
--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\
--etcd-cafile=/opt/etcd/ssl/ca.pem \\
--etcd-certfile=/opt/etcd/ssl/server.pem \\
--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\
--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\
--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\
--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\
--requestheader-allowed-names=kubernetes \\
--requestheader-extra-headers-prefix=X-Remote-Extra- \\
--requestheader-group-headers=X-Remote-Group \\
--requestheader-username-headers=X-Remote-User \\
--enable-aggregator-routing=true \\
--audit-log-maxage=30 \\
--audit-log-maxbackup=3 \\
--audit-log-maxsize=100 \\
--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;
EOF</code></pre></div><h3 id="创建系统服务文件"><a href="#创建系统服务文件" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/conf/kube-apiserver.conf
ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h3 id="自启启动-2"><a href="#自启启动-2" class="headerlink" title="自启启动"></a>自启启动</h3><div class="code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload
systemctl enable kube-apiserver --now</code></pre></div><h2 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h2><h3 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span>
cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF
&#123;
  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;ShangHai&quot;, 
      &quot;ST&quot;: &quot;ShangHai&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    &#125;
  ]
&#125;
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span>
cp cfssl/kubernetes/kube-controller-manager*.pem /etc/kubernetes/ssl</code></pre></div><h3 id="创建配置文件-1"><a href="#创建配置文件-1" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-controller-manager.conf &lt;&lt; EOF
KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--leader-elect=true \\
--kubeconfig=/opt/kubernetes/conf/kube-controller-manager.kubeconfig \\
--bind-address=127.0.0.1 \\
--allocate-node-cidrs=true \\
--cluster-cidr=10.244.0.0/16 \\
--service-cluster-ip-range=10.0.0.0/24 \\
--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--cluster-signing-duration=87600h0m0s&quot;
EOF</code></pre></div><h3 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><div class="code-wrapper"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-controller-manager.kubeconfig&quot;
KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=$&#123;KUBE_APISERVER&#125; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-credentials kube-controller-manager \
  --client-certificate=/opt/kubernetes/ssl/kube-controller-manager.pem \
  --client-key=/opt/kubernetes/ssl/kube-controller-manager-key.pem \
  --embed-certs=true \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-controller-manager \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</code></pre></div><h3 id="创建系统服务文件-1"><a href="#创建系统服务文件-1" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/conf/kube-controller-manager.conf
ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h3 id="自启启动-3"><a href="#自启启动-3" class="headerlink" title="自启启动"></a>自启启动</h3><div class="code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload
systemctl enable kube-controller-manager --now</code></pre></div><h2 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h2><h3 id="证书-1"><a href="#证书-1" class="headerlink" title="证书"></a>证书</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span>
cat &gt; kube-scheduler-csr.json &lt;&lt; EOF
&#123;
  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;ShangHai&quot;,
      &quot;ST&quot;: &quot;ShangHai&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    &#125;
  ]
&#125;
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span>
cp cfssl/kubernetes/kube-cheduler*.pem /etc/kubernetes/ssl</code></pre></div><h3 id="创建配置文件-2"><a href="#创建配置文件-2" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-scheduler.conf &lt;&lt; EOF
KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--leader-elect \\
--kubeconfig=/opt/kubernetes/conf/kube-scheduler.kubeconfig \\
--bind-address=127.0.0.1&quot;
EOF</code></pre></div><h3 id="创建kubeconfig文件-1"><a href="#创建kubeconfig文件-1" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><div class="code-wrapper"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-scheduler.kubeconfig&quot;
KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=$&#123;KUBE_APISERVER&#125; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-credentials kube-scheduler \
  --client-certificate=/opt/kubernetes/ssl/kube-scheduler.pem \
  --client-key=/opt/kubernetes/ssl/kube-scheduler-key.pem \
  --embed-certs=true \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-scheduler \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</code></pre></div><h3 id="创建系统服务"><a href="#创建系统服务" class="headerlink" title="创建系统服务"></a>创建系统服务</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/conf/kube-scheduler.conf
ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h3 id="自启启动-4"><a href="#自启启动-4" class="headerlink" title="自启启动"></a>自启启动</h3><div class="code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload
systemctl enable kube-scheduler --now</code></pre></div><h2 id="查看集群状态-1"><a href="#查看集群状态-1" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><h3 id="证书-2"><a href="#证书-2" class="headerlink" title="证书"></a>证书</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span>
cat &gt; admin-csr.json &lt;&lt;EOF
&#123;
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;ShangHai&quot;,
      &quot;ST&quot;: &quot;ShangHai&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    &#125;
  ]
&#125;
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span>
cp cfssl/kubernetes/admin*.pem /etc/kubernetes/ssl</code></pre></div><h3 id="创建kubeconfig文件-2"><a href="#创建kubeconfig文件-2" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><div class="code-wrapper"><pre><code class="hljs shell">mkdir /root/.kube

KUBE_CONFIG=&quot;/root/.kube/config&quot;
KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=$&#123;KUBE_APISERVER&#125; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-credentials cluster-admin \
  --client-certificate=//etc/kubernetes/ssl/admin.pem \
  --client-key=/etc/kubernetes/ssl/admin-key.pem \
  --embed-certs=true \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-context default \
  --cluster=kubernetes \
  --user=cluster-admin \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</code></pre></div><h3 id="查看当前组建状态"><a href="#查看当前组建状态" class="headerlink" title="查看当前组建状态"></a>查看当前组建状态</h3><div class="code-wrapper"><pre><code class="hljs shell">kubectl get cs
NAME                STATUS    MESSAGE             ERROR
scheduler           Healthy   ok                  
controller-manager  Healthy   ok                   
etcd-master         Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;
etcd-minio          Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  
etcd-slave          Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</code></pre></div><h3 id="授权kubelet-bootstrap用户允许请求证书"><a href="#授权kubelet-bootstrap用户允许请求证书" class="headerlink" title="授权kubelet-bootstrap用户允许请求证书"></a>授权kubelet-bootstrap用户允许请求证书</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建node必备，不然node的kubelet无法启动,就是创建一个可以申请证书的用户</span>
kubectl create clusterrolebinding kubelet-bootstrap \
--clusterrole=system:node-bootstrapper \
--user=kubelet-bootstrap

kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin ?--user=system:anonymous</code></pre></div><h1 id="Nodes"><a href="#Nodes" class="headerlink" title="Nodes"></a>Nodes</h1><h2 id="拷贝二进制文件和证书"><a href="#拷贝二进制文件和证书" class="headerlink" title="拷贝二进制文件和证书"></a>拷贝二进制文件和证书</h2><div class="code-wrapper"><pre><code class="hljs shell">ssh minion &quot;mkdir -p /opt/kubernetes/&#123;bin,conf,ssl,logs&#125;&quot;
cd kubernetes/server/bin/
scp -r kubelet kube-proxy minion:/opt/kubernetes/bin/
scp /opt/kubernetes/ssl/ca.pem minion:/opt/kubernetes/ssl/
scp /usr/bin/kubectl minion:/usr/bin</code></pre></div><h2 id="kubulet"><a href="#kubulet" class="headerlink" title="kubulet"></a>kubulet</h2><h3 id="创建配置文件-3"><a href="#创建配置文件-3" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kubelet.conf &lt;&lt; EOF
KUBELET_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--hostname-override=(节点名) \\
--network-plugin=cni \\
--kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig \\
--bootstrap-kubeconfig=/opt/kubernetes/conf/bootstrap.kubeconfig \\
--config=/opt/kubernetes/conf/kubelet-config.yml \\
--cert-dir=/opt/kubernetes/ssl \\
--pod-infra-container-image=lizexiong/pause-amd64:3.0(pause镜像)&quot;
EOF</code></pre></div><h3 id="配置参数文件"><a href="#配置参数文件" class="headerlink" title="配置参数文件"></a>配置参数文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kubelet-config.yml &lt;&lt; EOF
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
cgroupDriver: systemd(和docker的cgroupdriver保持一致)
clusterDNS:
- 10.0.0.2
clusterDomain: cluster.local 
failSwapOn: false
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /opt/kubernetes/ssl/ca.pem 
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
maxOpenFiles: 1000000
maxPods: 110
EOF</code></pre></div><h3 id="创建kubeconfig文件-3"><a href="#创建kubeconfig文件-3" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><div class="code-wrapper"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/bootstrap.kubeconfig&quot;
KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot; # apiserver IP:PORT
TOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot; # 与token.csv里保持一致
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">生成 kubelet bootstrap kubeconfig 配置文件</span>
kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=$&#123;KUBE_APISERVER&#125; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-credentials &quot;kubelet-bootstrap&quot; \
  --token=$&#123;TOKEN&#125; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-context default \
  --cluster=kubernetes \
  --user=&quot;kubelet-bootstrap&quot; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</code></pre></div><h3 id="创建系统服务文件-2"><a href="#创建系统服务文件-2" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
After=docker.service

[Service]
EnvironmentFile=/opt/kubernetes/conf/kubelet.conf
ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h3 id="自启启动-5"><a href="#自启启动-5" class="headerlink" title="自启启动"></a>自启启动</h3><div class="code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload
systemctl enable kubelet --now</code></pre></div><h3 id="master批准node加入集群"><a href="#master批准node加入集群" class="headerlink" title="master批准node加入集群"></a>master批准node加入集群</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">获取node-csr名称</span>
kubectl get csr 
<span class="hljs-meta prompt_">#</span><span class="language-bash">批准</span>
kubectl certificate approve &lt;node-csr-name&gt;
<span class="hljs-meta prompt_">#</span><span class="language-bash">获取节点信息</span>
kubectl get node</code></pre></div><h2 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h2><h3 id="创建配置文件-4"><a href="#创建配置文件-4" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-proxy.conf &lt;&lt; EOF
KUBE_PROXY_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--config=/opt/kubernetes/conf/kube-proxy-config.yml&quot;
EOF</code></pre></div><h3 id="配置参数文件-1"><a href="#配置参数文件-1" class="headerlink" title="配置参数文件"></a>配置参数文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-proxy-config.yml &lt;&lt; EOF
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
metricsBindAddress: 0.0.0.0:10249
clientConnection:
  kubeconfig: /opt/kubernetes/conf/kube-proxy.kubeconfig
hostnameOverride: node01
clusterCIDR: 10.0.0.0/24
EOF</code></pre></div><h3 id="master生成证书并拷贝"><a href="#master生成证书并拷贝" class="headerlink" title="master生成证书并拷贝"></a>master生成证书并拷贝</h3><div class="code-wrapper"><pre><code class="hljs shell">cd cfssl/kubernetes

cat &gt; kube-proxy-csr.json &lt;&lt; EOF
&#123;
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;ShangHai&quot;,
      &quot;ST&quot;: &quot;ShangHai&quot;,
      &quot;O&quot;: &quot;Kubernets&quot;,
      &quot;OU&quot;: &quot;System&quot;
    &#125;
  ]
&#125;
EOF
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span>
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span>
scp /cfssl/kubernetes/kube-proxy*pem minion:/opt/kubernetes/ssl</code></pre></div><h3 id="创建kubeconfig文件-4"><a href="#创建kubeconfig文件-4" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><div class="code-wrapper"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-proxy.kubeconfig&quot;
KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=$&#123;KUBE_APISERVER&#125; \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-credentials kube-proxy \
  --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \
  --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=$&#123;KUBE_CONFIG&#125;
kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</code></pre></div><h3 id="创建系统服务文件-3"><a href="#创建系统服务文件-3" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h3><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Proxy
After=network.target

[Service]
EnvironmentFile=/opt/kubernetes/conf/kube-proxy.conf
ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h3 id="自启启动-6"><a href="#自启启动-6" class="headerlink" title="自启启动"></a>自启启动</h3><div class="code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload
systemctl enable kube-proxy --now</code></pre></div><h2 id="部署网络组件"><a href="#部署网络组件" class="headerlink" title="部署网络组件"></a>部署网络组件</h2><h3 id="calico"><a href="#calico" class="headerlink" title="calico"></a>calico</h3><div class="code-wrapper"><pre><code class="hljs shell">https://blog.csdn.net/qq_31136839/article/details/100032022
<span class="hljs-meta prompt_">#</span><span class="language-bash">下载yaml</span>
wget https://docs.projectcalico.org/manifests/calico.yaml
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">修改CALICO_IPV4POOL_CIDR,此处的网段地址应和kube-controller-manager.conf中的--cluster-cidr保持一致,修改后应用</span>
kubectl apply -f calico.yaml
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod直到成功运行</span>
kubectl get pods -n kube-system</code></pre></div><h3 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h3><div class="code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改Network,此处的网段地址应和kube-controller-manager.conf中的--cluster-cidr保持一致,修改后应用</span>
kubectl apply -f flannel.yaml
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod直到成功运行</span>
kubectl get pods -n kube-system
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">如果报错找不到/run/flannel/subnet.env</span>
cat &gt; /run/flannel/subnet.env &lt;&lt; EOF
FLANNEL_NETWORK=10.244.0.0/16
FLANNEL_SUBNET=10.244.0.1/24
FLANNEL_MTU=1450
FLANNEL_IPMASQ=true
EOF</code></pre></div><h2 id="授权apiserver"><a href="#授权apiserver" class="headerlink" title="授权apiserver"></a>授权apiserver</h2><div class="code-wrapper"><pre><code class="hljs shell">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - &quot;*&quot;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &quot;&quot;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF

kubectl apply -f apiserver-to-kubelet-rbac.yaml</code></pre></div><h2 id="部署Coredns"><a href="#部署Coredns" class="headerlink" title="部署Coredns"></a>部署Coredns</h2><div class="code-wrapper"><pre><code class="hljs shell">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.in
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">修改dns_memory_limit和clusterIP,clusterIP地址应和kubelet-config.yml中的clusterDNS保持一致,修改后应用</span>
kubelet apply -f coredns.yaml
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">授权</span>
kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:coredns
<span class="hljs-meta prompt_"></span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod成功运行</span>
kubectl get pods -n kube-system</code></pre></div></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/" class="category-chain-item">学海无涯</a> <span>></span> <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/K8S/" class="category-chain-item">K8S</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/devops/">#devops</a> <a href="/tags/kubernetes/">#kubernetes</a></div></div><div class="license-box my-3"><div class="license-title"><div>通过二进制方式部署Kubernetes集群</div><div>http://example.com/study/kubernetes/Bianry-Deploy-Kubernetes/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Felix Cheung</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年12月22日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/study/others/My-Hexo/" title="搭建我的Hexo博客"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">搭建我的Hexo博客</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/study/kubernetes/Kubeadm-Deploy-HA-Kubernetes/" title="通过Kubeadm部署Kubernetes高可用集群"><span class="hidden-mobile">通过Kubeadm部署Kubernetes高可用集群</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>